container_commands:
  01_install_all_deps:
    command: "npm ci --include=dev"
    cwd: "/var/app/staging"
    leader_only: true
  02_build_app:
    command: "npm run build"
    cwd: "/var/app/staging"
    leader_only: true
  03_cleanup_devdeps:
    command: "npm prune --omit=dev"
    cwd: "/var/app/staging"
    leader_only: true
  04_verify_build:
    command: |
      if [ ! -d ".next" ]; then
        echo "ERROR: .next directory not found after build!"
        exit 1
      fi
      if [ ! -f ".next/BUILD_ID" ]; then
        echo "ERROR: BUILD_ID file not found! Build may have failed."
        exit 1
      fi
      echo "Build verification successful - .next directory exists"
      ls -la .next/
    cwd: "/var/app/staging"
    leader_only: true
  05_fix_permissions:
    command: "chown -R webapp:webapp .next"
    cwd: "/var/app/staging"
    leader_only: true