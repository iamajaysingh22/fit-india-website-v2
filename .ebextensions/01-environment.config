option_settings:
  aws:elasticbeanstalk:container:nodejs:
    NodeCommand: "npm start"
    
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx
    
  aws:elasticbeanstalk:application:environment:
    NPM_CONFIG_PRODUCTION: false
    NPM_USE_PRODUCTION: false
    
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.micro
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
    
  aws:autoscaling:asg:
    MinSize: 1
    MaxSize: 2
    
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

files:
  "/etc/nginx/conf.d/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      upstream nodejs {
        server 127.0.0.1:8081;
        keepalive 256;
      }
      
      server {
        listen 80;
        location / {
          proxy_pass  http://nodejs;
          proxy_set_header   Connection "";
          proxy_http_version 1.1;
          proxy_set_header        Host            $host;
          proxy_set_header        X-Real-IP       $remote_addr;
          proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header        X-Forwarded-Proto $scheme;
        }
        
        location /_next/static {
          alias /var/app/current/.next/static;
          expires 1y;
          add_header Cache-Control "public, immutable";
        }
        
        location /static {
          alias /var/app/current/public;
          expires 1y;
          add_header Cache-Control "public, immutable";
        }
        
        gzip on;
        gzip_comp_level 4;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml+rss text/javascript;
      }

container_commands:
  01_install_all_deps:
    command: "npm ci --include=dev"
    cwd: "/var/app/staging"
    leader_only: true
  02_build_app:
    command: "npm run build"
    cwd: "/var/app/staging"
    leader_only: true
  03_cleanup_devdeps:
    command: "npm prune --omit=dev"
    cwd: "/var/app/staging"
    leader_only: true
  04_verify_build:
    command: |
      if [ ! -d ".next" ]; then
        echo "ERROR: .next directory not found after build!"
        exit 1
      fi
      if [ ! -f ".next/BUILD_ID" ]; then
        echo "ERROR: BUILD_ID file not found! Build may have failed."
        exit 1
      fi
      echo "Build verification successful - .next directory exists"
      ls -la .next/
    cwd: "/var/app/staging"
    leader_only: true
  05_fix_permissions:
    command: "chown -R webapp:webapp .next"
    cwd: "/var/app/staging"
    leader_only: true