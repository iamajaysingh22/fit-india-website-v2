commands:
  01_update_npm:
    command: "npm install -g npm@latest"
    ignoreErrors: true
  02_clear_npm_cache:
    command: "npm cache clean --force"
    ignoreErrors: true

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/00_set_node_env.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      export NODE_ENV=production
      export NPM_CONFIG_PRODUCTION=false
      echo "NODE_ENV set to production"
      echo "NPM_CONFIG_PRODUCTION set to false (to allow dev dependencies for build)"
      
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_install_node_modules.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/staging
      echo "Installing all dependencies..."
      npm ci
      echo "Dependencies installed successfully"
      
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_build_nextjs.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/staging
      echo "Building Next.js application..."
      npm run build
      if [ $? -eq 0 ]; then
        echo "Next.js build completed successfully"
        echo "Verifying .next directory..."
        ls -la .next/
      else
        echo "Next.js build failed!"
        exit 1
      fi
